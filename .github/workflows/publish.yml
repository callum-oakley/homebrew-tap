on:
  repository_dispatch:
    types: [publish]
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install jfn
      - run: |
          repo='https://github.com/callum-oakley/jfn'
          version=${{ github.event.client_payload.version }}
          for os in {macos,linux}; do            
            "${os}_sha256=$(
              curl -sfL "${repo}/releases/download/v${version}/jfn-${version}-${os}.tar.gz" |
                shasum -a 256 | jfn '$.match(/[0-9a-f]{64}/)'
            )"
          done
          cat jfn.rb |
            version="${version}" macos_sha256="${macos_sha256}" linux_sha256="${linux_sha256}" jfn '
              $.replace(
                /(?<=version\s+")[^"]*(?=")/,
                $version,
              ).replace(
                /(?<=macos.tar.gz"\s+sha256\s+")[^"]*(?=")/,
                $macos_sha256,
              ).replace(
                /(?<=linux.tar.gz"\s+sha256\s+")[^"]*(?=")/,
                $linux_sha256,
              )
            ' > jfn.rb.new
          mv jfn.rb.new jfn.rb
      - run: git config --global user.name 'Callum Oakley'
      - run: git config --global user.email 'hello@callumoakley.net'
      - run: git commit -am 'jfn ${{ github.event.client_payload.version }}'
      - run: git push
